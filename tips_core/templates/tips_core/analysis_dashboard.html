{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-light fw-bold mb-4 border-bottom pb-2">{{ title }}</h1>
    <p class="text-secondary lead">Resumo de performance por método de aposta concluída (Ganhos e Perdas).</p>

    {% if summary %}

        <!-- RESUMO GERAL -->
        <div class="mt-4 p-3 bg-dark rounded shadow-lg">
            <h5 class="text-light">Totais Globais (Apostas Concluídas)</h5>
            <p class="lead fw-bold text-light">
                Lucro Líquido Geral: 
                <span class="{% if global_net_profit > 0 %}text-success{% elif global_net_profit < 0 %}text-danger{% else %}text-secondary{% endif %}">
                    R$ {{ global_net_profit|floatformat:2 }}
                </span>
            </p>
            <p class="text-secondary">Total Apostado: R$ {{ global_stakes|floatformat:2 }}</p>
        </div>

        <h2 class="text-light fw-bold mt-5 mb-3 border-bottom pb-2">Detalhes por Método</h2>

        <div class="table-responsive bg-dark rounded shadow-lg p-3">
            <table class="table table-dark table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th class="text-info">Data</th>
                        <th class="text-warning">Método</th>
                        <th>Total Apostado (R$)</th>
                        <th>Lucro Líquido (R$)</th>
                        <th>Yield (%)</th>
                        <th>Total Tips</th>
                        <th>W/L</th>
                    </tr>
                </thead>
                <tbody>

                    {% for item in summary %}
                    <tr data-method="{{ item.method_name }}"
                        data-profit="{{ item.lucro_liquido_total|floatformat:2 }}"
                        data-wins="{{ item.total_wins }}"
                        data-losses="{{ item.total_losses }}"
                        data-date="{{ item.match_date|date:'Y-m' }}">
                        
                        <td class="text-secondary small">
                            {{ item.match_date|date:"d/m/Y" }}
                        </td>
                        
                        <td class="fw-bold text-warning">{{ item.method_name }}</td>
                        <td>R$ {{ item.total_aposta|floatformat:2 }}</td>

                        <td class="fw-bold 
                            {% if item.lucro_liquido_total > 0 %}text-info
                            {% elif item.lucro_liquido_total < 0 %}text-danger
                            {% else %}text-secondary{% endif %}">
                            R$ {{ item.lucro_liquido_total|floatformat:2 }}
                        </td>

                        <td class="fw-bold 
                            {% if item.yield_percent > 0 %}text-success
                            {% elif item.yield_percent < 0 %}text-danger
                            {% else %}text-secondary{% endif %}">
                            {{ item.yield_percent|floatformat:2 }}%
                        </td>

                        <td>{{ item.total_apostas }}</td>
                        <td>{{ item.total_wins }} / {{ item.total_losses }}</td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>
        </div>

        <h2 class="text-light fw-bold mt-5 mb-3 border-bottom pb-2">Gráficos Estatísticos</h2>

        <div class="row">

            <!-- GRÁFICO 1 -->
            <div class="col-md-6 mb-4">
                <div class="mt-4 p-3 bg-dark rounded shadow-lg h-100">
                    <h5 class="text-light mb-3 border-bottom pb-2">Lucro Líquido por Método (R$)</h5>
                    <div style="height: 300px;">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- GRÁFICO 2 -->
            <div class="col-md-6 mb-4">
                <div class="mt-4 p-3 bg-dark rounded shadow-lg h-100">
                    <h5 class="text-light mb-3 border-bottom pb-2">Distribuição Global Win/Loss</h5>
                    <div style="height: 300px;">
                        <canvas id="winLossChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- GRÁFICO 3 (REAL) -->
            <div class="col-12 mb-4">
                <div class="mt-4 p-3 bg-dark rounded shadow-lg">
                    <h5 class="text-light mb-3 border-bottom pb-2">Evolução Mensal (Lucro Líquido)</h5>
                    <div style="height: 350px;">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

    {% else %}
        <div class="alert alert-info text-center">Nenhum resultado concluído para gerar resumo.</div>
    {% endif %}
    
    <div class="mt-5 text-center">
        <a href="{% url 'home' %}" class="btn btn-warning btn-lg">Voltar</a>
    </div>
</div>

<style>
.table-responsive { overflow-x: auto; }
</style>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
Chart.register(ChartDataLabels);

document.addEventListener("DOMContentLoaded", () => {

    const rows = document.querySelectorAll("tbody tr");

    let labels = [];
    let profitData = [];
    let winCount = 0;
    let lossCount = 0;
    let profitColors = [];

    // ---- COLETA DADOS ----
    rows.forEach(row => {
        const method = row.dataset.method;
        const profit = parseFloat(row.dataset.profit);
        const wins = parseInt(row.dataset.wins);
        const losses = parseInt(row.dataset.losses);

        labels.push(method);
        profitData.push(profit);

        winCount += wins;
        lossCount += losses;

        profitColors.push(
            profit > 0 ? "rgba(25,135,84,0.8)" :
            profit < 0 ? "rgba(220,53,69,0.8)" :
            "rgba(108,117,125,0.8)"
        );
    });

    // ------------------------------------------------------------------
    // GRÁFICO 1 – LUCRO POR MÉTODO
    // ------------------------------------------------------------------
    new Chart(document.getElementById("profitChart"), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Lucro Líquido",
                data: profitData,
                backgroundColor: profitColors,
                borderColor: profitColors.map(c => c.replace("0.8","1")),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: "#ffffff" } },
                title: {
                    display: true,
                    text: "Lucro Líquido por Método",
                    color: "#ffffff"
                },
                datalabels: {
                    color: "#ffffff",
                    anchor: "end",
                    align: "top",
                    formatter: v => "R$ " + v.toFixed(2)
                }
            },
            scales: {
                x: { ticks: { color: "#ffffff" } },
                y: { ticks: { color: "#ffffff" } }
            }
        }
    });

    // ------------------------------------------------------------------
    // GRÁFICO 2 – WIN/LOSS
    // ------------------------------------------------------------------
    new Chart(document.getElementById("winLossChart"), {
        type: "doughnut",
        data: {
            labels: ["Wins", "Losses"],
            datasets: [{
                data: [winCount, lossCount],
                backgroundColor: [
                    "rgba(25,135,84,0.9)",
                    "rgba(220,53,69,0.9)"
                ]
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: "bottom",
                    labels: { color: "#ffffff" }
                },
                title: {
                    display: true,
                    text: "Distribuição Total de Resultados",
                    color: "#ffffff"
                },
                datalabels: {
                    color: "#ffffff",
                    formatter: (v, ctx) => {
                        const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                        return ((v/total)*100).toFixed(1) + "%";
                    }
                }
            }
        }
    });

    // ------------------------------------------------------------------
    // GRÁFICO 3 – EVOLUÇÃO MENSAL (REAL)
    // ------------------------------------------------------------------
    let monthly = {};

    rows.forEach(row => {
        const month = row.dataset.date;
        const profit = parseFloat(row.dataset.profit);

        if (!monthly[month]) monthly[month] = 0;
        monthly[month] += profit;
    });

    const monthlyLabels = Object.keys(monthly).sort();
    const monthlyValues = monthlyLabels.map(m => monthly[m]);
    const monthlyColors = monthlyValues.map(v =>
        v >= 0 ? "rgba(25,135,84,1)" : "rgba(220,53,69,1)"
    );

    new Chart(document.getElementById("monthlyChart"), {
        type: "line",
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: "Lucro Mensal (R$)",
                data: monthlyValues,
                borderColor: "rgba(255,193,7,1)",
                pointBackgroundColor: monthlyColors,
                pointRadius: 6
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: "#ffffff" } },
                title: {
                    display: true,
                    text: "Evolução de Lucro Líquido Mensal",
                    color: "#ffffff"
                },
                datalabels: {
                    color: "#ffffff",
                    align: "top",
                    formatter: v => "R$ " + v.toFixed(2)
                }
            },
            scales: {
                x: { ticks: { color: "#ffffff" } },
                y: { ticks: { color: "#ffffff" } }
            }
        }
    });

});
</script>
{% endblock extra_js %}
{% endblock content %}
