{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="display-5 text-light mb-4">An√°lise de Confronto Din√¢mica</h1>
            <p class="lead text-secondary mb-5">
                Insira o nome dos times e a informa√ß√£o que voc√™ deseja (ex: "Flamengo x Fluminense: desfalques e √∫ltimos resultados"). O Gemini far√° a an√°lise para voc√™.
            </p>
        </div>
    </div>
    
    <div class="tip-card p-4 shadow-lg"> 
        <form id="analiseForm"> 
            
            {% csrf_token %} {# --------------------------------------------- #}
            
            {# CAMPOS DE TIME 1 E TIME 2 REMOVIDOS CONFORME SOLICITADO #}
            
            <div class="mb-4">
                <label for="pedido" class="form-label text-warning fw-bold">Pedido/An√°lise Desejada:</label>
                <input type="text" id="pedido" name="pedido" class="form-control" 
                    placeholder="Ex: Desfalques e desempenho de Corinthians e Juventude" required>
                <div class="form-text text-secondary">Sugest√µes: desfalques, escala√ß√£o, √∫ltimos 5 jogos, an√°lise t√°tica.</div>
            </div>

            {# --------------------------------------------- #}
            
            <button type="submit" id="submitBtn" class="btn btn-warning btn-lg fw-bold w-100 mt-3">
                <i class="fas fa-search me-2"></i> Gerar An√°lise com Gemini
            </button>
            
        </form>
    </div>
    
    
    <hr class="my-5">
    
    <h2 class="text-light mb-4"><i class="fas fa-clipboard-list me-2 text-warning"></i> Resultado da An√°lise (Gemini)</h2>
    
    <div id="resultadoAnalise" class="p-4 bg-dark text-light rounded-3">
        <p class="text-secondary">Preencha o formul√°rio acima e clique em "Gerar An√°lise com Gemini" para ver o resumo aqui.</p>
    </div>
</div>

<script>
    // Fun√ß√£o para converter o Markdown (retorno do Gemini) em HTML b√°sico
    function formatMarkdownToHTML(markdownText) {
        let html = markdownText;
        
        // Substitui **negrito** por <strong>
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Substitui listas - por <ul>/<li>
        // (L√≥gica simples, pode precisar de mais complexidade para listas aninhadas)
        html = html.replace(/^- (.*)/gm, '<li>$1</li>');
        
        // Tenta envolver as listas em <ul> se elas existirem
        if (html.includes('<li>')) {
            // Usa replace para evitar quebras desnecess√°rias de <br> dentro de <li>
            html = html.replace(/<br>/g, '');
            html = '<ul>' + html.trim() + '</ul>';
        }
        
        // Adiciona quebras de linha (para t√≠tulos/par√°grafos)
        html = html.replace(/\n/g, '<br>'); 
        
        return html;
    }

    document.getElementById('analiseForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Impede o envio tradicional (recarregamento de p√°gina)
        
        // üõë time1 e time2 foram removidos, agora s√≥ coletamos o pedido üõë
        const pedido = document.getElementById('pedido').value;
        const resultadoDiv = document.getElementById('resultadoAnalise');
        const submitBtn = document.getElementById('submitBtn');

        // Estado de Carregamento
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Gerando An√°lise...';
        resultadoDiv.innerHTML = '<p class="text-info">Aguarde, o Gemini est√° buscando e analisando as informa√ß√µes...</p>';

        // Coleta o Token CSRF para seguran√ßa do Django
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(window.location.href, { // Envia POST para a mesma URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken // Token CSRF essencial
            },
            body: JSON.stringify({
                // time1 e time2 removidos do payload
                pedido: pedido
            })
        })
        .then(response => response.json())
        .then(data => {
            // Reabilita o bot√£o
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-search me-2"></i> Gerar An√°lise com Gemini';
            
            if (data.status === 'success') {
                // EXIBE A RESPOSTA FORMATADA AQUI
                resultadoDiv.innerHTML = formatMarkdownToHTML(data.analysis_text);
            } else {
                // Captura erro de l√≥gica ou falha de inicializa√ß√£o (se a view retornar um JSON de erro)
                resultadoDiv.innerHTML = `<p class="text-danger fw-bold">Erro de Processamento: ${data.message}</p>`;
            }
        })
        .catch(error => {
            // Este catch pega erros de rede ou o erro de JSON/HTML (Unexpected token '<')
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-search me-2"></i> Gerar An√°lise com Gemini';
            // A mensagem de erro sugere a causa prov√°vel
            resultadoDiv.innerHTML = `<p class="text-danger fw-bold">Erro de Comunica√ß√£o: O servidor retornou um erro inesperado (prov√°vel falha de seguran√ßa CSRF ou servidor inativo). Erro: ${error.message}</p>`;
        });
    });
</script>
{% endblock content %}